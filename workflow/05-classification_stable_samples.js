var c03_forest_formation = /* color: #0b4a8b */ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Point([-46.94980218770558, -25.48000977429318]),
            {
              "reference": 3,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-54.369233776596985, -25.846276864745125],
                  [-54.36719529774567, -25.84952110112796],
                  [-54.368525673417054, -25.84602581893455]]]),
            {
              "reference": 3,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Point([-54.36854713108917, -25.846952754663583]),
            {
              "reference": 3,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Point([-54.20409002357716, -25.844860395959493]),
            {
              "reference": 3,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-54.20460500770802, -25.84648254470121],
                  [-54.20160093361134, -25.842774743460584],
                  [-54.20134344154591, -25.838448828460354],
                  [-54.20597829872364, -25.84524662386822]]]),
            {
              "reference": 3,
              "system:index": "4"
            }),
        ee.Feature(
            ee.Geometry.Point([-54.27933433850432, -25.681788546750685]),
            {
              "reference": 3,
              "system:index": "5"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-54.274699481326586, -25.68430245658826],
                  [-54.28006389935637, -25.679738704087214],
                  [-54.273454936343676, -25.689098075922917]]]),
            {
              "reference": 3,
              "system:index": "6"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-54.24156883557463, -25.664228374571287],
                  [-54.249722750979906, -25.66430573783067],
                  [-54.23770645459319, -25.668096476052394]]]),
            {
              "reference": 3,
              "system:index": "7"
            }),
        ee.Feature(
            ee.Geometry.Point([-54.243285449344164, -25.665079367663903]),
            {
              "reference": 3,
              "system:index": "8"
            }),
        ee.Feature(
            ee.Geometry.Point([-54.26498463376902, -26.50092491521355]),
            {
              "reference": 3,
              "system:index": "9"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-54.26513483747385, -26.501232163659427],
                  [-54.262581374491674, -26.503248461199778],
                  [-54.262538459147436, -26.502288323926447],
                  [-54.26537087186716, -26.49986874241527],
                  [-54.26543524488352, -26.500732884517703]]]),
            {
              "reference": 3,
              "system:index": "10"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-54.26044941430954, -26.492430915745533],
                  [-54.25499916559128, -26.499958822550326],
                  [-54.25594330316452, -26.494850653844995]]]),
            {
              "reference": 3,
              "system:index": "11"
            }),
        ee.Feature(
            ee.Geometry.Point([-54.256629948672334, -26.494889061975574]),
            {
              "reference": 3,
              "system:index": "12"
            }),
        ee.Feature(
            ee.Geometry.Point([-54.197609924911994, -26.474811249559895]),
            {
              "reference": 3,
              "system:index": "13"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-54.197845959305305, -26.475041738313678],
                  [-54.19353296720936, -26.4808038070715],
                  [-54.19398357832386, -26.477154530371898],
                  [-54.19665505850269, -26.471248218833225],
                  [-54.19678380453541, -26.472323862377984]]]),
            {
              "reference": 3,
              "system:index": "14"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-55.039011395208114, -27.13430126569999],
                  [-55.04433283412239, -27.131054906673306],
                  [-55.05008349025032, -27.130443814009638],
                  [-55.03935465419075, -27.136783737969402]]]),
            {
              "reference": 3,
              "system:index": "15"
            }),
        ee.Feature(
            ee.Geometry.Point([-55.04424700343392, -27.1322006964161]),
            {
              "reference": 3,
              "system:index": "16"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-54.94921102640568, -27.098369591843447],
                  [-54.94534864542423, -27.103336046576008],
                  [-54.94337453958927, -27.10211355508215],
                  [-54.94715108988224, -27.09737627446116]]]),
            {
              "reference": 3,
              "system:index": "17"
            }),
        ee.Feature(
            ee.Geometry.Point([-54.94667902109562, -27.099401104413936]),
            {
              "reference": 3,
              "system:index": "18"
            }),
        ee.Feature(
            ee.Geometry.Point([-54.90035264517225, -26.98407776202457]),
            {
              "reference": 3,
              "system:index": "19"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-54.89505261609076, -26.987051111604185],
                  [-54.89724128271497, -26.98388654553955],
                  [-54.900674510254035, -26.98453668026286],
                  [-54.894709277404914, -26.989336088023563]]]),
            {
              "reference": 3,
              "system:index": "20"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-54.73192757170468, -26.922196809697276],
                  [-54.7290307859686, -26.92485614533259],
                  [-54.72867673437863, -26.9237943317871],
                  [-54.731047820190085, -26.922038975733706]]]),
            {
              "reference": 3,
              "system:index": "21"
            }),
        ee.Feature(
            ee.Geometry.Point([-54.730350432803924, -26.92308645053821]),
            {
              "reference": 3,
              "system:index": "22"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-55.632186386313506, -27.618785565793544],
                  [-55.632513615241685, -27.619265630463754],
                  [-55.63245460729416, -27.61978372004577],
                  [-55.631456825461456, -27.62091495689172],
                  [-55.631499740805694, -27.6194319924683]]]),
            {
              "reference": 3,
              "system:index": "23"
            }),
        ee.Feature(
            ee.Geometry.Point([-55.631735775199004, -27.619546067367736]),
            {
              "reference": 3,
              "system:index": "24"
            }),
        ee.Feature(
            ee.Geometry.Point([-54.75916816762003, -26.7003142227396]),
            {
              "reference": 3,
              "system:index": "25"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-54.757108231096595, -26.701550656355437],
                  [-54.757902164965, -26.70087972505093],
                  [-54.75841714909586, -26.70065927533122],
                  [-54.75892140439066, -26.70048674916606],
                  [-54.757569571047156, -26.701646503362053]]]),
            {
              "reference": 3,
              "system:index": "26"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-54.76234333209813, -26.699393988856762],
                  [-54.75973622493566, -26.700318926615683],
                  [-54.76058190563055, -26.6996609630144],
                  [-54.76145630576941, -26.699325492291273],
                  [-54.76256674030157, -26.69896605827743]]]),
            {
              "reference": 3,
              "system:index": "27"
            }),
        ee.Feature(
            ee.Geometry.Point([-54.76216630630315, -26.699178328714193]),
            {
              "reference": 3,
              "system:index": "28"
            }),
        ee.Feature(
            ee.Geometry.Point([-54.46278687561087, -25.695166029911285]),
            {
              "reference": 3,
              "system:index": "29"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-54.46291562164358, -25.69540772716958],
                  [-54.4609200581365, -25.69710926198365],
                  [-54.461070261841336, -25.6954173950497]]]),
            {
              "reference": 3,
              "system:index": "30"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-54.363410032979395, -25.59133600250269],
                  [-54.36545387081885, -25.590890899896642],
                  [-54.368211157425144, -25.59061994431974],
                  [-54.37299621830771, -25.590174830373428],
                  [-54.37330736415978, -25.591200527989724],
                  [-54.370399839981296, -25.591413404203593],
                  [-54.36594740167169, -25.591771477828054],
                  [-54.36357096401665, -25.592124643182355],
                  [-54.361709482773044, -25.591781103340924]]]),
            {
              "reference": 3,
              "system:index": "31"
            }),
        ee.Feature(
            ee.Geometry.Point([-54.3696769893839, -25.590852932594782]),
            {
              "reference": 3,
              "system:index": "32"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-54.35620157129308, -25.594026734372747],
                  [-54.36036435968419, -25.59197538431083],
                  [-54.3552145183756, -25.59650378944615]]]),
            {
              "reference": 3,
              "system:index": "33"
            }),
        ee.Feature(
            ee.Geometry.Point([-54.35688821680089, -25.593949325575142]),
            {
              "reference": 3,
              "system:index": "34"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-54.300386547668744, -25.56939145402031],
                  [-54.30321896038847, -25.5721399996021],
                  [-54.299356579407025, -25.569894713563386]]]),
            {
              "reference": 3,
              "system:index": "35"
            }),
        ee.Feature(
            ee.Geometry.Point([-54.300343632324505, -25.56997213792075]),
            {
              "reference": 3,
              "system:index": "36"
            }),
        ee.Feature(
            ee.Geometry.Point([-54.321608185394574, -25.584217367538965]),
            {
              "reference": 3,
              "system:index": "37"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-54.31974136792021, -25.581333619596673],
                  [-54.32072842083769, -25.58023042247853],
                  [-54.32094299755888, -25.58375287592098]]]),
            {
              "reference": 3,
              "system:index": "38"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-54.378445262472496, -25.62803607094065],
                  [-54.37402498201595, -25.636780453565162],
                  [-54.374754542868004, -25.630821961457762]]]),
            {
              "reference": 3,
              "system:index": "39"
            }),
        ee.Feature(
            ee.Geometry.Point([-54.375956172506676, -25.632137498278304]),
            {
              "reference": 3,
              "system:index": "40"
            }),
        ee.Feature(
            ee.Geometry.Point([-54.36994802431332, -25.630086802216514]),
            {
              "reference": 3,
              "system:index": "41"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-54.36861764864193, -25.630396343501275],
                  [-54.37359582857357, -25.627571749536457],
                  [-54.36831724123226, -25.63364647854968]]]),
            {
              "reference": 3,
              "system:index": "42"
            }),
        ee.Feature(
            ee.Geometry.Point([-54.28476026029263, -26.401123515850795]),
            {
              "reference": 3,
              "system:index": "43"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-54.2841649030082, -26.400496141594303],
                  [-54.28781270726845, -26.399650467003756],
                  [-54.280989167534564, -26.404993488722365]]]),
            {
              "reference": 3,
              "system:index": "44"
            })]),
    c09_forest_plantation = /* color: #d63000 */ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Point([-45.85116937520558, -25.420488570620154]),
            {
              "reference": 9,
              "system:index": "0"
            })]),
    c15_pasture = /* color: #00ffff */ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Point([-45.67538812520558, -25.9946212274054]),
            {
              "reference": 15,
              "system:index": "0"
            })]),
    c19_annual_crops = /* color: #bf04c2 */ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Point([-45.19198968770558, -25.022931573068227]),
            {
              "reference": 19,
              "system:index": "0"
            })]),
    c22_non_vegetated_area = /* color: #00ff00 */ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Point([-44.75253656270558, -25.658396476528893]),
            {
              "reference": 22,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-54.39217791551018, -25.844943785232108],
                  [-54.39004287713433, -25.846372821187465],
                  [-54.390128707822804, -25.845803140004456],
                  [-54.3916951178875, -25.844808605261413]]]),
            {
              "reference": 22,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Point([-54.3912981509533, -25.845214144710024]),
            {
              "reference": 22,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Point([-54.41691492128217, -25.86707089988542]),
            {
              "reference": 22,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-54.4169202857002, -25.867090207683248],
                  [-54.41769276189649, -25.86703228428031],
                  [-54.41810045766675, -25.86785769009176],
                  [-54.4168666415199, -25.867138477164016]]]),
            {
              "reference": 22,
              "system:index": "4"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-54.406403677391125, -25.846090798303532],
                  [-54.40551318399818, -25.84707566673335],
                  [-54.40571703188331, -25.846168043182626]]]),
            {
              "reference": 22,
              "system:index": "5"
            }),
        ee.Feature(
            ee.Geometry.Point([-54.40586723558815, -25.846341843976184]),
            {
              "reference": 22,
              "system:index": "6"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-54.38426220705653, -25.84779885552536],
                  [-54.3845089702859, -25.849073371173283],
                  [-54.38398325731898, -25.84804024211904]]]),
            {
              "reference": 22,
              "system:index": "7"
            }),
        ee.Feature(
            ee.Geometry.Point([-54.38419783404017, -25.84819472928047]),
            {
              "reference": 22,
              "system:index": "8"
            }),
        ee.Feature(
            ee.Geometry.Point([-54.29951659773737, -25.920163649067995]),
            {
              "reference": 22,
              "system:index": "9"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-54.29899625051097, -25.920697990897676],
                  [-54.29943613158354, -25.919965833137383],
                  [-54.29970166983045, -25.919770429553417],
                  [-54.29969094098111, -25.919946534021975],
                  [-54.298985521087296, -25.92090424919038]]]),
            {
              "reference": 22,
              "system:index": "10"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-54.30695754625342, -25.933996192685754],
                  [-54.306965592880466, -25.93480906973819],
                  [-54.30664372726798, -25.93482957276308],
                  [-54.30611801483176, -25.9348597236122]]]),
            {
              "reference": 22,
              "system:index": "11"
            }),
        ee.Feature(
            ee.Geometry.Point([-54.30673224069617, -25.93452926699409]),
            {
              "reference": 22,
              "system:index": "12"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-54.44430872328833, -25.89439031644837],
                  [-54.44247409232214, -25.89576084516519],
                  [-54.443155373411926, -25.894916331112498]]]),
            {
              "reference": 22,
              "system:index": "13"
            }),
        ee.Feature(
            ee.Geometry.Point([-54.443198288756165, -25.894945285980047]),
            {
              "reference": 22,
              "system:index": "14"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-54.44571956523016, -25.89577049671945],
                  [-54.44483175857517, -25.89644127937874],
                  [-54.44385811217383, -25.896919026039164],
                  [-54.444284585725086, -25.896453342443262],
                  [-54.44503291972235, -25.895987656481335]]]),
            {
              "reference": 22,
              "system:index": "15"
            }),
        ee.Feature(
            ee.Geometry.Point([-54.44489821232917, -25.896122777909277]),
            {
              "reference": 22,
              "system:index": "16"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-54.42460641606695, -25.8983245074412],
                  [-54.42339942201025, -25.899873538142522],
                  [-54.42389294846899, -25.898821550660625]]]),
            {
              "reference": 22,
              "system:index": "17"
            }),
        ee.Feature(
            ee.Geometry.Point([-54.42388221963293, -25.898942191902997]),
            {
              "reference": 22,
              "system:index": "18"
            }),
        ee.Feature(
            ee.Geometry.Point([-54.4265429709757, -25.899101438154066]),
            {
              "reference": 22,
              "system:index": "19"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-54.426494691213435, -25.899371673724698],
                  [-54.42562565549261, -25.90003760873922],
                  [-54.42654833539373, -25.898705734951914]]]),
            {
              "reference": 22,
              "system:index": "20"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-54.37770759326522, -25.90027054530146],
                  [-54.37828695041244, -25.90119705550141],
                  [-54.377020682334624, -25.900231772336692]]]),
            {
              "reference": 22,
              "system:index": "21"
            }),
        ee.Feature(
            ee.Geometry.Point([-54.37772905093734, -25.90054077819464]),
            {
              "reference": 22,
              "system:index": "22"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-54.487547023524954, -25.86314409266697],
                  [-54.48655997060747, -25.865325926356434],
                  [-54.48655997060747, -25.86360749434166]]]),
            {
              "reference": 22,
              "system:index": "23"
            }),
        ee.Feature(
            ee.Geometry.Point([-54.487032039394094, -25.863916427782044]),
            {
              "reference": 22,
              "system:index": "24"
            })]),
    c33_water = /* color: #0000ff */ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Point([-45.80722406270558, -26.231379266651032]),
            {
              "reference": 33,
              "system:index": "0"
            })]),
    c48_perennial_crops = /* color: #999900 */ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Point([-45.12607171895558, -25.974869771147393]),
            {
              "reference": 48,
              "system:index": "0"
            })]),
    c65_Te = /* color: #98ff00 */ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Point([-46.882299773516344, -26.548054593312898]),
            {
              "reference": 65,
              "system:index": "0"
            })])
;

var region_name = "reg_3"
var yearini = 2000

var year_list =   [2000, 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019, 2020, 2021,2022]

var version_stable_in = '1'  
var version_class_out = '1'
var stage_out = 'step_04-complement'
var version_samples_out = 1     

var trainPoints = 2000   // Number of points to training
var validPoints = 300   // Number of points to validate

var complementary_samples_03 = 200
var complementary_samples_09 = 200
var complementary_samples_11 = 200
var complementary_samples_12 = 500
var complementary_samples_15 = 100
var complementary_samples_19 = 200
var complementary_samples_22 = 200
var complementary_samples_33 = 200
var complementary_samples_48 = 200
var complementary_samples_65 = 200

var nTrees = 100;
var variablesPerSplit = 4
var minLeafPopulation = 25  
var seed = 1

var regions = ee.FeatureCollection("projects/mapbiomas_af_trinacional/ANCILLARY_DATA/VECTOR/Regiones_AR-PY_col3");
var myRegion = regions.filterMetadata('Reg_id', 'equals', region_name)

var dir1 = 'projects/nexgenmap/MapBiomas2/LANDSAT/ATLANTICFOREST/mosaics'
var dir2 = 'projects/nexgenmap/MapBiomas2/LANDSAT/ATLANTICFOREST/mosaics-landsat-7'
var mosaicos1 = ee.ImageCollection(dir1)
var mosaicos2 = ee.ImageCollection(dir2)
var dirasset = mosaicos1.merge(mosaicos2)

var dir_pre_class = 'projects/mapbiomas_af_trinacional/COLLECTION3/complement_samples/'

var outputAsset = 'projects/mapbiomas_af_trinacional/SAMPLES/Coleccion3/Stable_samples';
var outputAsset2 = 'projects/mapbiomas_af_trinacional/SAMPLES/Coleccion3/complement_samples/';

var blank = ee.Image(0).mask(0);
var outline = blank.paint(myRegion, 'AA0000', 2); 
var visPar = {'palette':'000000','opacity': 0.6};
Map.addLayer(outline, visPar, region_name, true);
Map.addLayer(regions, {}, 'regions', false);


var vis = {"opacity":1,//"bands":["classification_2022"],
"min":1,"max":65,"palette":["#129912","#1f4423","#006400","#00ff00","#687537","#76a5af","#29eee4","#77a605","#935132",
"#bbfcac","#45c2a5","#b8af4f","#f1c232","#ffffb2","#ffd966","#f6b26b","#f99f40","#e974ed","#d5a6bd","#c27ba0","#fff3bf",
"#ea9999","#dd7e6b","#aa0000","#ff99ff","#0000ff","#d5d5e5","#dd497f","#b2ae7c","#af2a2a","#8a2be2","#968c46","#0000ff",
"#4fd3ff","#645617","#fae1f9","#000000","#000000","#f5b3c8","#c71585","#f54ca9","#000000","#000000","#000000","#000000",
"#d68fe2","#9932cc","#e6ccff","#02d659","#ad5100","#000000","#000000","#000000","#000000","#000000","#000000","#000000",
"#000000","#000000","#000000","#000000","#ff69b4","#000000","#000000","#842b4c"]};

var visParMedian2 = {'bands':['nir_median','swir1_median','red_median'], 'max':3187.5, 'gamma':1.32 };

var year_land = [2000, 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019, 2020, 2021,2022]
                   
for (var year_id in year_land){
  var year = year_land[year_id]


  var mosaicoTotal = ee.ImageCollection(dirasset)
                    .filterMetadata('year', 'equals', year)
                    .filterBounds(myRegion)
                    .mosaic()
                    .clip(myRegion)
  Map.addLayer(mosaicoTotal, visParMedian2, 'Land_'+year+'_TRINACIONAL', false);  
}

var bandNames = ee.List([
"blue_median",
"cai_median",
"evi2_median",
"evi2_median_dry",
"evi2_median_wet",
"gcvi_median_dry",
"green_median",
"green_median_wet",
"green_min",
"gv_stdDev",
"gvs_median_wet",
"ndfi_median",
"ndfi_median_wet",
"ndvi_median",
"ndvi_median_wet",
"ndwi_median",
"ndwi_median_wet",
"nir_median",
"nir_median_wet",
"nir_min",
"red_median",
"red_median_dry",
"red_median_wet",
"red_min",
"savi_median",
"savi_median_dry",
"savi_median_wet",
"shade_median",
"swir1_median",
"swir1_median_dry",
"swir1_median_wet",
"swir1_min",
"swir2_median",
"swir2_median_dry",
"swir2_median_wet",
"swir2_min",
"wefi_median_wet"
]);
  
var samplesList = [c03_forest_formation, c15_pasture,
                    c22_non_vegetated_area]
                     
var totalSample = ee.List(samplesList).iterate(
    function (sample, totalSample) {
        return ee.FeatureCollection(totalSample).merge(sample);
    },
    samplesList[0]
);
totalSample = ee.FeatureCollection(totalSample).filterBounds(myRegion);

var amostraTotalimg = totalSample.reduceToImage({properties: ['reference'],reducer: ee.Reducer.first()})
amostraTotalimg = amostraTotalimg.select([0],['reference'])

  var training = amostraTotalimg.stratifiedSample({
    'numPoints': 1,
    'classBand': 'reference',
    'region': totalSample.filterBounds(myRegion),
    'scale': 30,
    'seed': 1,
    'classValues': [3,11, 12, 15, 22],//MODIFICAR
    'classPoints': [complementary_samples_03,complementary_samples_15,complementary_samples_22],//MODIFICAR
    'dropNulls': true,
    'geometries': true
});

////LEYENDA
var names = [
              "[03] Natural Forest",
              //"[04] Savanna Formation",
              "[09] Forest Plantation",
              //"[11] Wetland",
              //"[12] Grassland",
              "[15] Pasture",
              "[19] Annual crops",
              //"[21] Mosaic_agriculture_pasture",
              "[22] Non vegetated area",
              "[33] Water",
              "[48] Perennial crops",
              "[65] Te"
            ];

var colors = [
              "006400",//3
              //"32cd32",//4
              "935132",//9
              //"45c2a5",//11
              //"b8af4f",//12
              "ffd966",//15
              "d5a6bd",//19
              //"ffefc3",//21
              "EA9999",//22
              "0000ff",//33
              "dd497f",//48
              "842b4c",//65
              ];

              
var legend = ui.Panel({
  style: {
    position: 'bottom-left',
    padding: '8px 15px'
  }
});

// Create and add the legend title.
var legendTitle = ui.Label({
  value: 'MapBiomas AF Col. 3',
  style: {
    fontWeight: 'bold',
    fontSize: '16px',
    margin: '0 0 4px 0',
    padding: '0'
  }
});

legend.add(legendTitle);

// var loading = ui.Label('Legend:', {margin: '2px 0 4px 0'});
// legend.add(loading);

var makeRow = function(color, name) {
  // Create the label that is actually the colored box.
  var colorBox = ui.Label({
    style: {
      backgroundColor: '#' + color,
      // Use padding to give the box height and width.
      padding: '8px',
      margin: '0 0 4px 0'
    }
  });

  // Create the label filled with the description text.
  var description = ui.Label({
    value: name,
    style: {margin: '0 0 4px 6px'}
  });

  return ui.Panel({
    widgets: [colorBox, description],
    layout: ui.Panel.Layout.Flow('horizontal')
  });
};

for (var i = 0; i < names.length; i++){
legend.add(makeRow(colors[i], names[i]));
}
  Map.add(legend);
  

//////////////////////////////////////////////////////////////////////////////////////////
  
// Add mosaic for each year
for (var year_id in year_list){
  var year = year_list[year_id]
  var mosaicoTotal = ee.ImageCollection(dirasset)
                    .filterMetadata('year', 'equals', year)
                    .filterBounds(myRegion.geometry())
                    .mosaic()
 // Map.addLayer(mosaicoTotal, visParMedian2, 'Land_'+year, false);  
  var stable_samples = ee.FeatureCollection(outputAsset + '/' + region_name  +  '-stable_points_v'+version_stable_in +  "-col_3_" + yearini + "_filter")
  
    .filterMetadata("year","equals",year)
     print(stable_samples.size(), "muestras estables "+year) 

  mosaicoTotal = mosaicoTotal.clip(myRegion)
    mosaicoTotal = mosaicoTotal.select(bandNames)
  
  var training_year = mosaicoTotal.sampleRegions({
    'collection': training,
    'properties': ['reference'],
    'scale': 30,
    'geometries':false
  });

  print("complementary samples "+year, training_year.size())
  
  var training_complementar = stable_samples.merge(training_year)
  print(training_complementar.size(),"muestras totales "+year)

  var classifier = ee.Classifier.smileRandomForest({
            'numberOfTrees': nTrees,
            'variablesPerSplit': variablesPerSplit, 
            'minLeafPopulation': minLeafPopulation, 
            'seed': seed}).train(training_complementar, 'reference', bandNames);
            
  var classified = mosaicoTotal.classify(classifier).mask(mosaicoTotal.select('blue_median'));
  classified = classified.select(['classification'],['classification_'+year]).clip(myRegion).toInt8()
  Map.addLayer(classified, vis, 'RF'+year+"_"+region_name, false);
  
  if (year_id == 0){ var classified00a22 = classified }  
  else {classified00a22 = classified00a22.addBands(classified); }
}
classified00a22 = classified00a22
.set('collection', 3)
.set('version', version_class_out)
.set('region_name', region_name)
.set('step', stage_out)
.set('type', 'region')
print(classified00a22)

  Map.addLayer(stable_samples.filterMetadata('reference','equals',3), {'color': "006400"}, 'Natural Forest', false)
  Map.addLayer(stable_samples.filterMetadata('reference','equals',9), {'color': "935132 "}, 'Forest Plantation', false)
  Map.addLayer(stable_samples.filterMetadata('reference','equals',15), {'color': "ffd966"}, 'Pasture', false)
  Map.addLayer(stable_samples.filterMetadata('reference','equals',19), {'color': "d5a6bd"}, 'Annual crops', false)
  Map.addLayer(stable_samples.filterMetadata('reference','equals',22), {'color': "EA9999"}, 'Non vegetated area', false)
  Map.addLayer(stable_samples.filterMetadata('reference','equals',33), {'color': "0000ff"}, 'Water', false)
  Map.addLayer(stable_samples.filterMetadata('reference','equals',48), {'color': "dd497f"}, 'Perennial crops', false)
  Map.addLayer(stable_samples.filterMetadata('reference','equals',65), {'color': "842b4c"}, 'Te', false)


Export.image.toAsset({
  "image": classified00a22.toInt8(),
  "description": region_name+ '-'+ 'col_3_' + yearini +'_class_v'+version_class_out,
  "assetId": dir_pre_class + stage_out + '_' + region_name+ '-'+ 'col_3_' + yearini +'_class_v'+version_class_out,
  "scale": 30,
  "pyramidingPolicy": {
      '.default': 'mode'
  },
  "maxPixels": 1e13,
  "region": myRegion
});    

var shuffle = function (collection, seed) {

    // Adds a column of deterministic pseudorandom numbers to a collection.
    // The range 0 (inclusive) to 1000000000 (exclusive).
    collection = collection.randomColumn('random', seed || 1)
        .sort('random', true)
        .map(
            function (feature) {
                var rescaled = ee.Number(feature.get('random'))
                    .multiply(1000000000)
                    .round();
                return feature.set('new_id', rescaled);
            }
        );

    // list of random ids
    var randomIdList = ee.List(
        collection.reduceColumns(ee.Reducer.toList(), ['new_id'])
        .get('list'));

    // list of sequential ids
    var sequentialIdList = ee.List.sequence(1, collection.size());

    // set new ids
    var shuffled = collection.remap(randomIdList, sequentialIdList, 'new_id');

    return shuffled;
};

var totalSample = ee.List(samplesList).iterate(
    function (sample, totalSample) {
        return ee.FeatureCollection(totalSample).merge(sample);
    },
    samplesList[0]
);
totalSample = ee.FeatureCollection(totalSample).filterBounds(myRegion);

var amostraTotalimg = totalSample.reduceToImage({properties: ['reference'],reducer: ee.Reducer.first()})
amostraTotalimg = amostraTotalimg.select([0],['reference'])

// shuffle points and reindex them
var shuffledpoly = shuffle(totalSample, 2);

// split range in %
var splitRange = [0.0, 0.7, 1.0];

var sizepoly = shuffledpoly.size();

var filter1 = ee.Filter.rangeContains('new_id',
    sizepoly.multiply(splitRange[0]).round().add(1),
    sizepoly.multiply(splitRange[1]).round());

var filter2 = ee.Filter.rangeContains('new_id',
    sizepoly.multiply(splitRange[1]).round().add(1),
    sizepoly.multiply(splitRange[2]).round());


var trainingpoly = shuffledpoly.filter(filter1)
    .map(function (feature) {
        return feature.set('type', 'training');
    });
    
var validationpoly = shuffledpoly.filter(filter2)
    .map(function (feature) {
        return feature.set('type', 'validation');
    });

var labeledSamplespoly = validationpoly.merge(trainingpoly);


var validation = amostraTotalimg.stratifiedSample({
    'numPoints': validPoints,
    'classBand': 'reference',
    'region': validationpoly.filterBounds(myRegion),
    'scale': 30,
    'seed': 1,
    'dropNulls': true,
    'geometries':true
});

validation = validation
    .map(function (feature) {
        return feature.set('type', 'validation');
    });
var training = amostraTotalimg.stratifiedSample({
    'numPoints': trainPoints,
    'classBand': 'reference',
    'region': trainingpoly.filterBounds(myRegion),
    'scale': 30,
    'seed': 1,
    'dropNulls': true,
    'geometries':true
});
training = training
    .map(function (feature) {
        return feature.set('type', 'training');
    });

print('exported samples')
print('# c03_forest_formation', training.filterMetadata('reference', 'equals', 3).size())
print('# c09_forest_plantation', training.filterMetadata('reference', 'equals', 9).size())
print('# c15_pasture', training.filterMetadata('reference', 'equals', 15).size())
print('# c19_annual_crops', training.filterMetadata('reference', 'equals', 19).size())
print('# c22_non_vegetated_area', training.filterMetadata('reference', 'equals', 22).size())
print('# c33_water', training.filterMetadata('reference', 'equals', 33).size())
print('# c48_perennial_crops', training.filterMetadata('reference', 'equals', 48).size())
print('# c65_Te', training.filterMetadata('reference', 'equals', 65).size())

var samplesList = [c03_forest_formation, c15_pasture,
                    c22_non_vegetated_area]


var labeledSamples = validation.merge(training);


print(labeledSamples.size(),"muestras complementarias totales")


Export.table.toAsset({
    "collection": labeledSamplespoly,
    "description": region_name  + '_stable-compl-poly_' + yearini + "_v" +version_samples_out + "_col3",
    "assetId": outputAsset2 + region_name  + '_stable-compl-poly_' + yearini + "_v" +version_samples_out + "_col3"
});

Export.table.toAsset({
    "collection": ee.FeatureCollection(labeledSamples),
    "description": region_name + '_stable-compl-points_'+ yearini + "_v" +version_samples_out + "_col3",
    "assetId": outputAsset2 + region_name  + '_stable-compl-points_'+ yearini + "_v" +version_samples_out + "_col3"
});

var LandCover_clases = classified00a22.select(2).reduceRegion({
  reducer  : ee.Reducer.frequencyHistogram(),
  geometry : myRegion,
  scale:30,
  bestEffort: true,
  maxPixels: 1e120});
print(LandCover_clases,"LandCover_clases")